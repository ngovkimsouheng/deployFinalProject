<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Place Creator with Image Upload</title>

    <link rel="stylesheet" href="../src/output.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#0A4536",
              secondary: "#FF914D",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-primary to-secondary p-5 font-sans"
  >
    <div
      class="max-w-3xl mx-auto bg-white/95 rounded-2xl p-10 shadow-xl backdrop-blur-sm"
    >
      <h1
        class="text-center text-4xl font-extrabold mb-8 bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary"
      >
        ğŸï¸ Place Creator
      </h1>

      <form id="placeForm" class="space-y-6">
        <!-- Place Name -->
        <div class="flex flex-col">
          <label for="name" class="font-semibold text-gray-700 mb-2"
            >Place Name *</label
          >
          <input
            type="text"
            id="name"
            name="name"
            required
            value="á‡á¸á•á¶ááŸ‹-á‘áŸáŸá…ášááŸá’á˜áŸ’á˜á‡á¶áá·- á€áŸ„áŸ‡á€á»á„"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
          />
        </div>

        <!-- Description -->
        <div class="flex flex-col">
          <label for="description" class="font-semibold text-gray-700 mb-2"
            >Description *</label
          >
          <textarea
            id="description"
            name="description"
            required
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md resize-vertical min-h-[120px]"
          >
           á‡á¶á€áŸ„áŠá¾ášá›áŸá„á€áŸ’á“á»á„á–áŸ’ášáŸƒ á‡á·áŸ‡á‘á¼á€á€á¶á™áŸ‰á¶á€áŸ‹ á‡á·áŸ‡á€á„áŸ‹á¡á¾á„á—áŸ’á“áŸ† á“á·á„ á˜á¾á›áŸááŸ’áœá–áŸ’ášáŸƒáŸ”
          </textarea>
        </div>

        <!-- Open Hours -->
        <div class="flex flex-col">
          <label for="openHours" class="font-semibold text-gray-700 mb-2"
            >Opening Hours</label
          >
          <input
            type="text"
            id="openHours"
            name="openHours"
            value="Open 24h"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
          />
        </div>

        <!-- Entry Fee -->
        <div class="flex flex-col">
          <label for="entryFee" class="font-semibold text-gray-700 mb-2"
            >Entry Fee ($)</label
          >
          <input
            type="number"
            id="entryFee"
            name="entryFee"
            value="0.00"
            step="0.01"
            min="0"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
          />
        </div>

        <!-- Location -->
        <div class="flex flex-col">
          <label for="location" class="font-semibold text-gray-700 mb-2"
            >Location (lat,lng)</label
          >
          <input
            type="text"
            id="location"
            name="location"
            value="10.7131,103.2343"
            placeholder="10.7131,103.2343"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
          />
        </div>

        <!-- Coordinates -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex flex-col">
            <label for="latitude" class="font-semibold text-gray-700 mb-2"
              >Latitude</label
            >
            <input
              type="text"
              id="latitude"
              name="latitude"
              value="00.00"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
            />
          </div>
          <div class="flex flex-col">
            <label for="longitude" class="font-semibold text-gray-700 mb-2"
              >Longitude</label
            >
            <input
              type="text"
              id="longitude"
              name="longitude"
              value="00.00"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
            />
          </div>
        </div>

        <!-- Category -->
        <div class="flex flex-col">
          <label for="categoryName" class="font-semibold text-gray-700 mb-2"
            >Category</label
          >
          <select
            id="categoryName"
            name="categoryName"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
          >
            <option value="Kep" selected>Phnom</option>
            <option value="Beach">Beach</option>
            <option value="Temple">Temple</option>
            <option value="Park">Park</option>
            <option value="Restaurant">Restaurant</option>
            <option value="Hotel">Hotel</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Image Upload -->
        <div class="flex flex-col">
          <label class="font-semibold text-gray-700 mb-2">Images</label>
          <div
            class="relative border-2 border-dashed border-primary rounded-xl p-6 text-center cursor-pointer hover:bg-primary/10"
            id="fileUpload"
          >
            <input
              type="file"
              id="images"
              accept="image/*"
              multiple
              class="absolute left-[-9999px]"
            />
            <span class="text-2xl block mb-2">ğŸ“</span>
            <span class="block text-gray-500"
              >Click to select images or drag and drop</span
            >
            <small class="text-gray-400"
              >Support multiple image files (JPG, PNG, GIF)</small
            >
          </div>
          <div
            id="imagePreview"
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4"
          ></div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          id="submitBtn"
          class="w-full bg-gradient-to-r from-primary to-secondary text-white font-semibold py-4 rounded-full hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-wide"
        >
          ğŸš€ Create Place
        </button>
      </form>

      <!-- Status -->
      <div id="status" class="mt-5 p-4 rounded-lg hidden"></div>
    </div>
    <script>
      const API_BASE = "https://tos-der.sokpheng.com/api/v1";
      let selectedFiles = [];

      const imageInput = document.getElementById("images");
      const imagePreview = document.getElementById("imagePreview");
      const form = document.getElementById("placeForm");
      const statusDiv = document.getElementById("status");
      const submitBtn = document.getElementById("submitBtn");

      // Handle file selection
      imageInput.addEventListener("change", function (e) {
        const files = Array.from(e.target.files);
        selectedFiles = files;
        displayImagePreviews();
      });

      function displayImagePreviews() {
        imagePreview.innerHTML = "";

        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const previewDiv = document.createElement("div");
            previewDiv.className = "preview-image";
            previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${
              index + 1
            }">
                        <button type="button" class="remove-image" onclick="removeImage(${index})">Ã—</button>
                    `;
            imagePreview.appendChild(previewDiv);
          };
          reader.readAsDataURL(file);
        });
      }

      function removeImage(index) {
        selectedFiles.splice(index, 1);
        displayImagePreviews();
      }

      function showStatus(message, type) {
        statusDiv.innerHTML = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = "block";
      }

      async function uploadImages() {
        if (selectedFiles.length === 0) {
          return [];
        }

        const formData = new FormData();
        selectedFiles.forEach((file) => {
          formData.append("files", file);
        });

        try {
          const response = await fetch(`${API_BASE}/upload/multiple`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(
              `Upload failed: ${response.status} ${response.statusText}`
            );
          }

          const result = await response.json();
          console.log("Upload response:", result);

          // Handle different possible response structures
          // Expected format: URLs like "https://tos-der.sokpheng.com/images/43149900-9b2c-4987-ab31-19724acaae43.png"
          if (result.urls && Array.isArray(result.urls)) {
            return result.urls;
          } else if (result.data && Array.isArray(result.data.urls)) {
            return result.data.urls;
          } else if (Array.isArray(result)) {
            // If response is directly an array of URLs
            return result;
          } else if (result.files && Array.isArray(result.files)) {
            // If response has files array, extract URLs
            return result.files.map((f) => f.url || f.path || f.filename);
          } else if (result.images && Array.isArray(result.images)) {
            // If response has images array
            return result.images.map((img) => img.url || img.path || img);
          } else {
            console.warn("Unexpected upload response structure:", result);
            // Try to extract any URLs from the response
            const possibleUrls = Object.values(result)
              .flat()
              .filter(
                (val) =>
                  typeof val === "string" &&
                  val.includes("tos-der.sokpheng.com/images/")
              );
            return possibleUrls.length > 0 ? possibleUrls : [];
          }
        } catch (error) {
          console.error("Image upload error:", error);
          throw new Error(`Image upload failed: ${error.message}`);
        }
      }

      async function createPlace(placeData) {
        try {
          const response = await fetch(`${API_BASE}/places`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(placeData),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Place creation failed: ${response.status} ${response.statusText} - ${errorText}`
            );
          }

          const result = await response.json();
          console.log("Place creation response:", result);
          return result;
        } catch (error) {
          console.error("Place creation error:", error);
          throw error;
        }
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        submitBtn.disabled = true;
        showStatus(
          '<div class="loading-spinner"></div>Processing...',
          "loading"
        );

        try {
          // Step 1: Upload images if any
          let imageUrls = [];
          if (selectedFiles.length > 0) {
            showStatus(
              '<div class="loading-spinner"></div>Uploading images...',
              "loading"
            );
            imageUrls = await uploadImages();
            console.log("Uploaded image URLs:", imageUrls);
          }

          const names = imageUrls.map((developer) => developer.uri);

          console.log("Uploaded image:", names);
          // Step 2: Prepare place data
          const formData = new FormData(form);
          const placeData = {
            name: formData.get("name"),
            description: formData.get("description"),
            openHours: formData.get("openHours"),
            entryFee: parseFloat(formData.get("entryFee")) || 0.0,
            imageUrls: names,
            location: formData.get("location"),
            latitude: formData.get("latitude"),
            longitude: formData.get("longitude"),
            categoryName: formData.get("categoryName"),
          };

          console.log("Sending place data:", placeData);

          // Step 3: Create place
          showStatus(
            '<div class="loading-spinner"></div>Creating place...',
            "loading"
          );
          const result = await createPlace(placeData);

          showStatus(
            `âœ… Place created successfully! ${
              imageUrls.length > 0
                ? `Uploaded ${imageUrls.length} image(s).`
                : "No images uploaded."
            }`,
            "success"
          );

          // Reset form
          form.reset();
          selectedFiles = [];
          imagePreview.innerHTML = "";

          // Restore default values
          document.getElementById("name").value =
            "á‡á¸á•á¶ááŸ‹-á‘áŸáŸá…ášááŸá’á˜áŸ’á˜á‡á¶áá·- á€áŸ„áŸ‡á€á»á„";
          document.getElementById("description").value =
            "á‡á¶á€áŸ„áŠá¾ášá›áŸá„á€áŸ’á“á»á„á–áŸ’ášáŸƒ á‡á·áŸ‡á‘á¼á€á€á¶á™áŸ‰á¶á€áŸ‹ á‡á·áŸ‡á€á„áŸ‹á¡á¾á„á—áŸ’á“áŸ† á“á·á„ á˜á¾á›áŸááŸ’áœá–áŸ’ášáŸƒáŸ”";
          document.getElementById("openHours").value = "Open 24h";
          document.getElementById("entryFee").value = "0.00";
          document.getElementById("location").value = "10.7131,103.2343";
          document.getElementById("latitude").value = "00.00";
          document.getElementById("longitude").value = "00.00";
          document.getElementById("categoryName").value = "Phnom";
        } catch (error) {
          console.error("Operation failed:", error);
          showStatus(`âŒ Error: ${error.message}`, "error");
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Drag and drop functionality
      const fileUpload = document.querySelector(".file-upload");

      fileUpload.addEventListener("dragover", function (e) {
        e.preventDefault();
        fileUpload.style.background = "rgba(102, 126, 234, 0.2)";
      });

      fileUpload.addEventListener("dragleave", function (e) {
        e.preventDefault();
        fileUpload.style.background = "rgba(102, 126, 234, 0.05)";
      });

      fileUpload.addEventListener("drop", function (e) {
        e.preventDefault();
        fileUpload.style.background = "rgba(102, 126, 234, 0.05)";

        const files = Array.from(e.dataTransfer.files).filter((file) =>
          file.type.startsWith("image/")
        );
        if (files.length > 0) {
          selectedFiles = files;
          displayImagePreviews();
        }
      });
    </script>
  </body>
</html>

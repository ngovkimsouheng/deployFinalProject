<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update Place</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../src/output.css" />
    <link
      rel="shortcut icon"
      href="../img/logo_derleng.png"
      type="image/x-icon"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#0A4536",
              secondary: "#FF914D",
              danger: "#DC2626",
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-gradient-to-br p-5 font-sans">
    <div
      class="max-w-4xl font-primary mx-auto bg-white/95 rounded-2xl p-10 shadow-xl backdrop-blur-sm"
    >
      <h1
        class="text-center text-primary text-4xl font-extrabold mb-8 bg-clip-text bg-gradient-to-r from-primary to-green-500"
      >
        កែប្រែទីកន្លែង
      </h1>

      <!-- Search and Select Place -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">
          ស្វែងរកកន្លែងដើម្បីកែប្រែ
        </h2>

        <!-- Search Input -->
        <div class="flex flex-col mb-4">
          <label for="searchInput" class="font-semibold text-gray-700 mb-2"
            >ស្វែងរកទីកន្លែង</label
          >
          <input
            type="text"
            id="searchInput"
            placeholder="វាយឈ្មោះកន្លែងដើម្បីស្វែងរក..."
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
          />
        </div>

        <!-- Places List -->
        <div id="placesList" class="space-y-2 max-h-64 overflow-y-auto hidden">
          <!-- Places will be loaded here -->
        </div>

        <!-- Load All Places Button -->
        <button
          id="loadPlacesBtn"
          class="w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-primary/90 transition-all"
        >
          📋 បង្ហាញកន្លែងទាំងអស់
        </button>
      </div>

      <!-- Update Form -->
      <form id="updateForm" class="hidden space-y-6">
        <input type="hidden" id="placeUuid" name="placeUuid" />
        
        <div class="bg-green-50 p-4 rounded-xl mb-6">
          <h3 class="text-lg font-semibold text-green-800 mb-2">
            កែប្រែព័ត៌មានទីកន្លែង
          </h3>
          <p class="text-green-700 text-sm">
            បំពេញតែផ្នែកដែលអ្នកចង់កែប្រែប៉ុណ្ណោះ។ ផ្នែកដទៃនឹងរក្សាទុកតម្លៃដើម។
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Place Name -->
          <div class="flex flex-col">
            <label for="placeName" class="font-semibold text-gray-700 mb-2"
              >ឈ្មោះទីកន្លែង *</label
            >
            <input
              type="text"
              id="placeName"
              name="placeName"
              required
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
              placeholder="បញ្ចូលឈ្មោះទីកន្លែង"
            />
          </div>

          <!-- Category -->
          <div class="flex flex-col">
            <label for="categoryId" class="font-semibold text-gray-700 mb-2"
              >ប្រភេទ *</label
            >
            <select
              id="categoryId"
              name="categoryId"
              required
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
            >
              <option value="">ជ្រើសរើសប្រភេទ</option>
            </select>
          </div>

          <!-- Entry Fee -->
          <div class="flex flex-col">
            <label for="entryFee" class="font-semibold text-gray-700 mb-2"
              >តម្លៃសំបុត្រចូល (USD)</label
            >
            <input
              type="number"
              id="entryFee"
              name="entryFee"
              min="0"
              step="0.01"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
              placeholder="0.00"
            />
          </div>

          <!-- Location -->
          <div class="flex flex-col">
            <label for="location" class="font-semibold text-gray-700 mb-2"
              >ទីតាំង</label
            >
            <input
              type="text"
              id="location"
              name="location"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
              placeholder="ខេត្ត, ស្រុក, ឃុំ"
            />
          </div>
        </div>

        <!-- Description -->
        <div class="flex flex-col">
          <label for="description" class="font-semibold text-gray-700 mb-2"
            >ពិពណ៌នា</label
          >
          <textarea
            id="description"
            name="description"
            placeholder="ពិពណ៌នាលម្អិតអំពីទីកន្លែងនេះ..."
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md resize-vertical min-h-[120px]"
          ></textarea>
        </div>

        <!-- Open Hours -->
        <div class="flex flex-col">
          <label for="openHours" class="font-semibold text-gray-700 mb-2"
            >ម៉ោងបើក</label
          >
          <input
            type="text"
            id="openHours"
            name="openHours"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
            placeholder="ឧ. 8:00 AM - 5:00 PM"
          />
        </div>

        <!-- Coordinates -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="flex flex-col">
            <label for="latitude" class="font-semibold text-gray-700 mb-2"
              >Latitude</label
            >
            <input
              type="number"
              id="latitude"
              name="latitude"
              step="any"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
              placeholder="11.5564"
            />
          </div>

          <div class="flex flex-col">
            <label for="longitude" class="font-semibold text-gray-700 mb-2"
              >Longitude</label
            >
            <input
              type="number"
              id="longitude"
              name="longitude"
              step="any"
              class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
              placeholder="104.9282"
            />
          </div>
        </div>

        <!-- Current Images Display -->
        <div id="currentImages" class="hidden">
          <h3 class="font-semibold text-gray-700 mb-3">រូបភាពបច្ចុប្បន្ន</h3>
          <div id="imagesList" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <!-- Current images will be displayed here -->
          </div>
        </div>

        <!-- New Images Upload -->
        <div class="flex flex-col">
          <label for="images" class="font-semibold text-gray-700 mb-2"
            >រូបភាពថ្មី (ជ្រើសរើសច្រើនរូបបាន)</label
          >
          <input
            type="file"
            id="images"
            name="images"
            multiple
            accept="image/*"
            class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90"
          />
          <p class="text-sm text-gray-500 mt-2">
            ជ្រើសរើសរូបភាពថ្មីដើម្បីជំនួសរូបភាពចាស់។ អាចជ្រើសរើសច្រើនរូបភាពក្នុងពេលតែមួយ។
          </p>
        </div>

        <!-- Image Preview -->
        <div id="imagePreview" class="hidden">
          <h3 class="font-semibold text-gray-700 mb-3">មើលរូបភាពថ្មីជាមុន</h3>
          <div id="previewList" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- New image previews will be displayed here -->
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col md:flex-row gap-4 pt-6">
          <button
            type="button"
            id="cancelBtn"
            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-4 rounded-xl transition-all"
          >
            បោះបង់
          </button>
          <button
            type="submit"
            id="updateBtn"
            class="flex-1 bg-[#0a4536] text-white font-semibold py-4 rounded-xl hover:shadow-lg transition-all"
          >
            រក្សាទុកការកែប្រែ
          </button>
        </div>
      </form>

      <!-- Status -->
      <div id="status" class="mt-5 p-4 rounded-lg hidden"></div>
    </div>

    <style>
      .place-item {
        transition: all 0.2s ease;
      }
      .place-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .place-item.selected {
        border-color: #0a4536;
        background-color: #f0fdf4;
      }
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #0a4536;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .image-preview {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        aspect-ratio: 1;
      }
      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .remove-image-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(220, 38, 38, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>

    <script>
      const API_BASE = "https://tos-der.sokpheng.com/api/v1";
      let allPlaces = [];
      let selectedPlace = null;
      let categories = [];

      const searchInput = document.getElementById("searchInput");
      const placesList = document.getElementById("placesList");
      const loadPlacesBtn = document.getElementById("loadPlacesBtn");
      const updateForm = document.getElementById("updateForm");
      const statusDiv = document.getElementById("status");
      const cancelBtn = document.getElementById("cancelBtn");
      const imagesInput = document.getElementById("images");
      const imagePreview = document.getElementById("imagePreview");
      const previewList = document.getElementById("previewList");

      let selectedImages = [];

      // Load categories and places on page load
      window.addEventListener("load", async function () {
        await loadCategories();
        await loadPlaces();
      });

      // Image upload functionality
      imagesInput.addEventListener("change", function(e) {
        selectedImages = Array.from(e.target.files);
        displayImagePreviews();
      });

      function displayImagePreviews() {
        if (selectedImages.length === 0) {
          imagePreview.classList.add("hidden");
          return;
        }

        imagePreview.classList.remove("hidden");
        previewList.innerHTML = "";

        selectedImages.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const imageDiv = document.createElement("div");
            imageDiv.className = "image-preview";
            imageDiv.innerHTML = `
              <img src="${e.target.result}" alt="Preview ${index + 1}" />
              <button type="button" class="remove-image-btn" onclick="removeImage(${index})">×</button>
            `;
            previewList.appendChild(imageDiv);
          };
          reader.readAsDataURL(file);
        });
      }

      function removeImage(index) {
        selectedImages.splice(index, 1);
        displayImagePreviews();
        
        // Update the file input
        const dt = new DataTransfer();
        selectedImages.forEach(file => dt.items.add(file));
        imagesInput.files = dt.files;
      }

      // Make removeImage function global for onclick handler
      window.removeImage = removeImage;

      // Load categories
      async function loadCategories() {
        try {
          const response = await fetch(`${API_BASE}/categories`);
          if (!response.ok) throw new Error("Failed to load categories");
          
          const result = await response.json();
          categories = result.data || result.categories || result || [];
          
          const categorySelect = document.getElementById("categoryId");
          categorySelect.innerHTML = '<option value="">ជ្រើសរើសប្រភេទ</option>';
          
          categories.forEach(category => {
            categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
          });
        } catch (error) {
          console.error("Error loading categories:", error);
          showStatus("❌ Failed to load categories", "error");
        }
      }

      // Load all places
      loadPlacesBtn.addEventListener("click", async function () {
        await loadPlaces();
      });

      async function loadPlaces() {
        loadPlacesBtn.disabled = true;
        loadPlacesBtn.innerHTML =
          '<div class="loading-spinner"></div>Loading places...';

        try {
          const response = await fetch(`${API_BASE}/places`);
          if (!response.ok) {
            throw new Error(`Failed to load places: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          allPlaces = result.data || result.places || result || [];

          displayPlaces(allPlaces);
          placesList.classList.remove("hidden");
          loadPlacesBtn.innerHTML = "🔄 ផ្ទុកកន្លែងឡើងវិញ";

          showStatus(`✅ Loaded ${allPlaces.length} places`, "success");
        } catch (error) {
          console.error("Error loading places:", error);
          showStatus(`❌ Error loading places: ${error.message}`, "error");
        } finally {
          loadPlacesBtn.disabled = false;
        }
      }

      // Search functionality
      searchInput.addEventListener("input", function (e) {
        const query = e.target.value.toLowerCase();
        filterPlaces(query);
      });

      function displayPlaces(places) {
        placesList.innerHTML = "";

        if (places.length === 0) {
          placesList.innerHTML =
            '<p class="text-gray-500 text-center py-4">No places found</p>';
          return;
        }

        places.forEach((place) => {
          const placeElement = document.createElement("div");
          placeElement.className =
            "place-item p-4 border-2 border-gray-200 rounded-xl cursor-pointer";
          placeElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">${place.name || "Unnamed Place"}</h3>
                <p class="text-sm text-gray-600 mt-1">${(place.description || "").substring(0, 100)}${(place.description || "").length > 100 ? "..." : ""}</p>
                <div class="flex items-center space-x-4 mt-2">
                  <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">${place.categoryName || "No Category"}</span>
                  <span class="text-xs text-gray-500">ID: ${place.id || "N/A"}</span>
                </div>
              </div>
              <div class="text-right">
                <span class="text-sm text-gray-500">$${place.entryFee || 0}</span>
              </div>
            </div>
          `;

          placeElement.addEventListener("click", () => selectPlace(place, placeElement));
          placesList.appendChild(placeElement);
        });
      }

      function selectPlace(place, element) {
        // Remove previous selection
        document.querySelectorAll(".place-item").forEach((item) => {
          item.classList.remove("selected");
        });

        // Select new place
        element.classList.add("selected");
        selectedPlace = place;

        // Populate form with place data
        populateForm(place);

        // Show update form
        updateForm.classList.remove("hidden");

        showStatus(`Selected: ${place.name}`, "info");
      }

      function populateForm(place) {
        // Fill form fields with current place data
        document.getElementById("placeUuid").value = place.uuid || "";
        document.getElementById("placeName").value = place.name || "";
        document.getElementById("categoryId").value = place.categoryId || "";
        document.getElementById("entryFee").value = place.entryFee || "";
        document.getElementById("location").value = place.location || "";
        document.getElementById("description").value = place.description || "";
        document.getElementById("openHours").value = place.openHours || "";
        document.getElementById("latitude").value = place.latitude || "";
        document.getElementById("longitude").value = place.longitude || "";

        // Display current images if any
        displayCurrentImages(place.imageUrls || []);

        // Reset image selection
        selectedImages = [];
        imagesInput.value = "";
        imagePreview.classList.add("hidden");
      }

      function displayCurrentImages(imageUrls) {
        const currentImagesDiv = document.getElementById("currentImages");
        const imagesListDiv = document.getElementById("imagesList");

        if (imageUrls.length > 0) {
          currentImagesDiv.classList.remove("hidden");
          imagesListDiv.innerHTML = "";

          imageUrls.forEach((imageUrl, index) => {
            const imageDiv = document.createElement("div");
            imageDiv.className = "image-preview";
            imageDiv.innerHTML = `
              <img src="${imageUrl}" alt="Place image ${index + 1}" />
            `;
            imagesListDiv.appendChild(imageDiv);
          });
        } else {
          currentImagesDiv.classList.add("hidden");
        }
      }

      function filterPlaces(query) {
        if (!query) {
          displayPlaces(allPlaces);
          return;
        }

        const filtered = allPlaces.filter((place) =>
          (place.name || "").toLowerCase().includes(query) ||
          (place.description || "").toLowerCase().includes(query) ||
          (place.categoryName || "").toLowerCase().includes(query)
        );

        displayPlaces(filtered);
      }

      // Cancel button
      cancelBtn.addEventListener("click", function () {
        updateForm.classList.add("hidden");
        selectedPlace = null;
        document.querySelectorAll(".place-item").forEach((item) => {
          item.classList.remove("selected");
        });
        showStatus("", "");
      });

      // Update form submission
      updateForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!selectedPlace) {
          showStatus("❌ Please select a place to update", "error");
          return;
        }

        const updateBtn = document.getElementById("updateBtn");
        updateBtn.disabled = true;
        showStatus('<div class="loading-spinner"></div>Updating place...', "loading");

        try {
          // Always use JSON approach since your API expects raw JSON with PATCH
          const response = await updateWithJSON();

          if (!response.ok) {
            let errorMessage = `Update failed: ${response.status} ${response.statusText}`;
            
            try {
              const errorData = await response.json();
              if (errorData.message) {
                errorMessage = errorData.message;
              } else if (errorData.error) {
                errorMessage = errorData.error;
              }
            } catch (e) {
              // Use default error message
            }
            
            throw new Error(errorMessage);
          }

          const result = await response.json();
          console.log("Update result:", result);

          // Handle image upload separately if images are selected
          if (selectedImages.length > 0) {
            try {
              await uploadImages();
              showStatus(`✅ Place "${selectedPlace.name}" and images updated successfully!`, "success");
            } catch (imageError) {
              console.error("Image upload failed:", imageError);
              showStatus(`✅ Place updated successfully, but image upload failed: ${imageError.message}`, "warning");
            }
          } else {
            showStatus(`✅ Place "${selectedPlace.name}" updated successfully!`, "success");
          }

          // Reset form and reload places
          updateForm.classList.add("hidden");
          selectedPlace = null;
          selectedImages = [];
          imagesInput.value = "";
          imagePreview.classList.add("hidden");
          await loadPlaces();

        } catch (error) {
          console.error("Update error:", error);
          showStatus(`❌ ${error.message}`, "error");
        } finally {
          updateBtn.disabled = false;
        }
      });

      // Update with JSON (matching your API structure)
      async function updateWithJSON() {
        const updateData = {};
        
        // Map form fields to API fields
        const fieldMapping = {
          'placeName': 'name',
          'categoryId': 'categoryId',
          'entryFee': 'entryFee',
          'location': 'location',
          'description': 'description',
          'openHours': 'openHours',
          'latitude': 'latitude',
          'longitude': 'longitude'
        };
        
        Object.keys(fieldMapping).forEach(formField => {
          const element = document.getElementById(formField);
          const value = element.value;
          const apiField = fieldMapping[formField];
          
          if (value && value.trim() !== "") {
            if (formField === "entryFee" || formField === "latitude" || formField === "longitude") {
              updateData[apiField] = parseFloat(value);
            } else if (formField === "categoryId") {
              updateData[apiField] = parseInt(value);
            } else {
              updateData[apiField] = value;
            }
          }
        });

        console.log("Updating place with JSON:", updateData);

        // Use PATCH method with JSON content type (as shown in your API docs)
        const response = await fetch(`${API_BASE}/places/${selectedPlace.uuid}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(updateData),
        });

        return response;
      }

      // Separate image upload function
      async function uploadImages() {
        if (selectedImages.length === 0) return;

        console.log("Uploading images separately...");

        const imageFormData = new FormData();
        selectedImages.forEach(file => {
          imageFormData.append("images", file);
        });

        // Try different image upload endpoints
        const imageEndpoints = [
          `${API_BASE}/places/${selectedPlace.uuid}/images`,
          `${API_BASE}/places/${selectedPlace.uuid}/upload-images`,
          `${API_BASE}/upload/places/${selectedPlace.uuid}`,
          `${API_BASE}/places/images/${selectedPlace.uuid}`,
          `${API_BASE}/upload-files/places/${selectedPlace.uuid}`
        ];

        let lastError;
        for (const endpoint of imageEndpoints) {
          try {
            console.log(`Trying image upload to: ${endpoint}`);
            const imageResponse = await fetch(endpoint, {
              method: "POST",
              body: imageFormData,
            });
            
            if (imageResponse.ok) {
              console.log("Image upload successful");
              return;
            } else {
              lastError = `${imageResponse.status} ${imageResponse.statusText}`;
            }
          } catch (error) {
            console.log(`Failed to upload to ${endpoint}:`, error);
            lastError = error.message;
          }
        }

        throw new Error(lastError || "All image upload endpoints failed");
      }

      function showStatus(message, type) {
        statusDiv.innerHTML = message;
        statusDiv.className = `mt-5 p-4 rounded-lg`;

        switch (type) {
          case "success":
            statusDiv.classList.add("bg-green-100", "text-green-800", "border", "border-green-300");
            break;
          case "error":
            statusDiv.classList.add("bg-red-100", "text-red-800", "border", "border-red-300");
            break;
          case "loading":
            statusDiv.classList.add("bg-blue-100", "text-blue-800", "border", "border-blue-300");
            break;
          case "warning":
            statusDiv.classList.add("bg-yellow-100", "text-yellow-800", "border", "border-yellow-300");
            break;
          case "info":
            statusDiv.classList.add("bg-gray-100", "text-gray-800", "border", "border-gray-300");
            break;
        }

        statusDiv.style.display = message ? "block" : "none";

        // Auto-hide success messages after 5 seconds
        if (type === "success") {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 5000);
        }
      }
    </script>
  </body>
</html>
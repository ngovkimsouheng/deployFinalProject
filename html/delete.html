<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>លុបទីកន្លែង</title>
    <link
      rel="shortcut icon"
      href="../img/logo/logoFooter.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="../src/output.css" />
    <link
      rel="shortcut icon"
      href="../img/logo_derleng.png"
      type="image/x-icon"
    />
    <script
      src="https://kit.fontawesome.com/5ce14b4205.js"
      crossorigin="anonymous"
    ></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#0A4536",
              secondary: "#FF914D",
              danger: "#DC2626",
            },​
          },
        },
      };
    </script>
  </head>
  <body class="bg-background dark:bg-dark_background font-primary">
    <header class="bg-white dark:text-white w-full shadow sticky top-0 z-10">
      <nav
        class="lg:container mx-auto flex items-center justify-between px-4 py-2"
      >
        <a href="../index.html" class="Logo">
          <img
            class="h-auto max-md:w-[100px] md:w-[140px]"
            src="../img/logo/logoHeader.png"
            alt="Logo"
          />
        </a>
        <button
          id="menu-toggle"
          class="lg:hidden text-accent cursor-pointer self-center text-3xl text-gray-850 focus:outline-none"
        >
          <ion-icon name="menu" id="menu-icon"></ion-icon>
        </button>

        <div
          id="nav-links"
          class="hidden lg:flex lg:items-center lg:gap-8 absolute top-16 left-0 w-full lg:static lg:w-auto p-4 max-sm:p-5 lg:p-0 transition-all duration-300 ease-in-out"
        >
          <ul
            class="flex font-primary max-lg:flex-col gap-6 lg:gap-8 text-lg max-lg:items-start font-medium"
          >
            <li>
              <a
                href="../index.html"
                class="text-accent hover:text-secondary transition-colors"
                >ទំព័រដើម</a
              >
            </li>
            <li>
              <a
                href="./about.html"
                class="text-accent hover:text-secondary transition-colors"
                >អំពីពួកយើង</a
              >
            </li>
            <li>
              <a
                href="./desti.html"
                class="text-secondary dark:text-dark-secondary transition-colors"
                >គោលដៅ</a
              >
            </li>
          </ul>

          <div
            class="flex font-primary flex-col lg:flex-row gap-4 mt-6 lg:mt-0"
          >
            <button
              id="toggleTheme"
              type="button"
              class="relative inline-flex h-12 w-12 items-center justify-center rounded-full bg-primary dark:bg-blue-950 dark:hover:bg-blue-900 shadow-sm outline-none ring-0 transition-colors duration-500"
              aria-label="Toggle dark mode"
            >
              <!-- SUN (visible in light, hides in dark) -->
              <svg
                class="absolute h-7 w-7 text-white transition-all duration-300 ease-out opacity-100 scale-100 rotate-0 dark:opacity-0 dark:scale-75 dark:rotate-90"
                viewBox="0 -960 960 960"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  d="M440-800v-120h80v120h-80Zm0 760v-120h80v120h-80Zm360-400v-80h120v80H800Zm-760 0v-80h120v80H40Zm708-252-56-56 70-72 58 58-72 70ZM198-140l-58-58 72-70 56 56-70 72Zm564 0-70-72 56-56 72 70-58 58ZM212-692l-72-70 58-58 70 72-56 56Zm268 452q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Z"
                />
              </svg>

              <!-- MOON (hidden in light, shows in dark) -->
              <svg
                class="absolute h-7 w-7 text-white transition-all duration-300 ease-out opacity-0 scale-75 rotate-90 dark:opacity-100 dark:scale-100 dark:rotate-0"
                viewBox="0 -960 960 960"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  d="M484-80q-84 0-157.5-32t-128-86.5Q144-253 112-326.5T80-484q0-146 93-257.5T410-880q-18 99 11 193.5T521-521q71 71 165.5 100T880-410q-26 144-138 237T484-80Z"
                />
              </svg>
            </button>
            <button
              class="group relative inline-flex h-12 items-center justify-center overflow-hidden rounded-[10px] border border-neutral-200 bg-primary dark:bg-blue-950 dark:hover:bg-blue-900 px-6 font-medium text-white transition-all active:translate-y-[2px] active:shadow-none"
            >
              <a href="./loginnnn.html">ចុះឈ្មោះ</a>
            </button>

            <button
              id="dropdownDelayButton"
              data-dropdown-toggle="dropdownDelay"
              data-dropdown-delay="500"
              class="border-neutral-200 bg-primary text-white cursor-pointer focus:ring-4 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-950 dark:hover:bg-blue-900"
              type="button"
            >
              ផ្សេងៗ
              <svg
                class="w-2.5 h-2.5 ms-3"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 10 6"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m1 1 4 4 4-4"
                />
              </svg>
            </button>
            <!-- Dropdown menu -->
            <div
              id="dropdownDelay"
              class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-sm w-44 dark:bg-blue-950"
            >
              <ul
                class="py-2 rounded-lg text-sm text-white bg-primary dark:bg-blue-950"
                aria-labelledby="dropdownDelayButton"
              >
                <li>
                  <a
                    href="./post.html"
                    class="block px-4 py-2 hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-white"
                    >បន្ថែមទីកន្លែង</a
                  >
                </li>
                <li>
                  <a
                    href="./update.html"
                    class="block px-4 py-2 hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-white"
                    >ធ្វើបច្ចុប្បន្នភាពទីកន្លែង</a
                  >
                </li>
                <li>
                  <a
                    href="./delete.html"
                    class="block px-4 py-2 hover:bg-gray-100 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-white"
                    >លុបទីកន្លែង</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main>
      <section class="min-h-screen bg-gradient-to-br p-5 font-sans">
        <div
          class="max-w-2xl font-primary mx-auto bg-white/95 rounded-2xl p-10 shadow-xl backdrop-blur-sm"
        >
          <h1
            class="text-center text-red-500 text-4xl font-extrabold mb-8 bg-clip-text bg-gradient-to-r from-danger to-red-500"
          >
            លុបទីកន្លែង
          </h1>

          <!-- Search and Select Place -->
          <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">
              ស្វែងរកកន្លែងដើម្បីលុប
            </h2>

            <!-- Search Input -->
            <div class="flex flex-col mb-4">
              <label for="searchInput" class="font-semibold text-gray-700 mb-2"
                >ស្វែងរកទីកន្លែង</label
              >
              <input
                type="text"
                id="searchInput"
                placeholder="វាយឈ្មោះកន្លែងដើម្បីស្វែងរក..."
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md transition"
              />
            </div>

            <!-- Places List -->
            <div
              id="placesList"
              class="space-y-2 max-h-64 overflow-y-auto hidden"
            >
              <!-- Places will be loaded here -->
            </div>

            <!-- Load All Places Button -->
            <button
              id="loadPlacesBtn"
              class="w-full bg-primary text-white font-semibold py-3 rounded-xl hover:bg-primary/90 transition-all"
            >
              បង្ហាញកន្លែងទាំងអស់
            </button>
          </div>

          <!-- Selected Place Info -->
          <div
            id="selectedPlaceInfo"
            class="hidden mb-8 p-6 bg-gray-50 rounded-xl"
          >
            <h3 class="text-lg font-semibold text-gray-700 mb-3">
              កន្លែងដែលបានជ្រើសរើស:
            </h3>
            <div id="placeDetails" class="space-y-2">
              <!-- Place details will be shown here -->
            </div>
          </div>

          <!-- Delete Form -->
          <form id="deleteForm" class="space-y-6">
            <input type="hidden" id="placeId" name="placeId" />

            <!-- Confirmation Input -->
            <div class="flex flex-col">
              <label for="confirmInput" class="font-semibold text-danger mb-2"
                >វាយពាក្យ "DELETE" ដើម្បីបញ្ជាក់ *</label
              >
              <input
                type="text"
                id="confirmInput"
                name="confirmInput"
                required
                placeholder="Type DELETE here"
                class="w-full p-4 border-2 border-red-200 rounded-xl focus:outline-none focus:border-danger focus:shadow-md transition"
              />
              <small class="text-gray-500 mt-1"
                >សកម្មភាពនេះមិនអាចត្រូវបានត្រឡប់វិញបានទេ!</small
              >
            </div>

            <!-- Reason (Optional) -->
            <div class="flex flex-col">
              <label for="reason" class="font-semibold text-gray-700 mb-2"
                >មូលហេតុសម្រាប់លុប (មិនបាច់បំពេញ)</label
              >
              <textarea
                id="reason"
                name="reason"
                placeholder="ហេតុអ្វីបានជាអ្នកលុបកន្លែងនេះ?"
                class="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:shadow-md resize-vertical min-h-[100px]"
              ></textarea>
            </div>

            <!-- Delete Button -->
            <div class="flex flex-col">
              <button
                type="submit"
                id="deleteBtn"
                disabled
                class="w-full bg-gradient-to-r bg-red-500 to-red-500 text-white font-semibold py-4 rounded-full hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-wide"
              >
                លុបកន្លែងជាអចិន្រ្តៃយ៍
              </button>
            </div>
          </form>

          <!-- Status -->
          <div id="status" class="mt-5 p-4 rounded-lg hidden"></div>
        </div>
      </section>
    </main>

    <footer class="bg-white mt-10 py-10">
      <div
        class="container mx-auto px-4 grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 text-left text-sm sm:text-base"
      >
        <div class="flex justify-center md:justify-start gap-4">
          <img
            src="../img/footer.PNG"
            alt="Logo 1"
            class="w-32 h-32 object-contain"
          />
          <img
            src="https://www.cstad.edu.kh/icon.png?ff407d7ec1c2072a"
            alt="Logo 2"
            class="w-27 h-27 object-contain mt-3"
          />
        </div>

        <div
          class="flex flex-col max-lg:mt-3 items-center md:items-start gap-5"
        >
          <h4 class="text-primary font-semibold text-lg">បណ្តាញសង្គម</h4>
          <div class="flex gap-4 text-primary">
            <!-- Facebook -->
            <a href="">
              <button
                class="group relative inline-flex h-14 w-14 items-center justify-center rounded-full border border-neutral-200 bg-white transition-all duration-300 ease-in-out [box-shadow:0px_4px_1px_#a3a3a3] active:translate-y-[2px] active:shadow-none"
              >
                <i class="fa-brands fa-facebook-f text-3xl text-primary"></i>
              </button>
            </a>

            <!-- TikTok -->
            <a href="">
              <button
                class="group relative inline-flex h-14 w-14 items-center justify-center rounded-full border border-neutral-200 bg-white transition-all duration-300 ease-in-out [box-shadow:0px_4px_1px_#a3a3a3] active:translate-y-[2px] active:shadow-none"
              >
                <i class="fa-brands fa-tiktok text-3xl text-primary"></i>
              </button>
            </a>

            <!-- YouTube -->
            <a href="">
              <button
                class="group relative inline-flex h-14 w-14 items-center justify-center rounded-full border border-neutral-200 bg-white transition-all duration-300 ease-in-out [box-shadow:0px_4px_1px_#a3a3a3] active:translate-y-[2px] active:shadow-none"
              >
                <i class="fa-brands fa-youtube text-3xl text-primary"></i>
              </button>
            </a>
          </div>
        </div>

        <div class="flex flex-col gap-5 items-center md:items-start">
          <h4 class="text-primary font-semibold text-lg">តំណភ្ជាប់រហ័ស</h4>
          <a href="index.html" class="hover:text-green-600 transition"
            >ទំព័រដើម</a
          >
          <a href="/html/about.html" class="hover:text-green-600 transition"
            >អំពីពួកយើង</a
          >
          <a
            href="/html/destination.html"
            class="hover:text-green-600 transition"
            >គោលដៅ</a
          >
        </div>

        <div class="flex flex-col gap-5 items-center md:items-start">
          <h4 class="text-primary font-semibold text-lg max-sm:text-center">
            ឧបត្ថម្ភដោយ
          </h4>
          <p>
            Institute of Science and Technology Advanced Development (ISTAD)
          </p>
        </div>
      </div>
    </footer>

    <style>
      .place-item {
        transition: all 0.2s ease;
      }
      .place-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .place-item.selected {
        border-color: #0a4536;
        background-color: #f0fdf4;
      }
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #0a4536;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>

    <script>
      const API_BASE = "https://tos-der.sokpheng.com/api/v1";
      let allPlaces = [];
      let selectedPlace = null;

      const searchInput = document.getElementById("searchInput");
      const placesList = document.getElementById("placesList");
      const loadPlacesBtn = document.getElementById("loadPlacesBtn");
      const selectedPlaceInfo = document.getElementById("selectedPlaceInfo");
      const placeDetails = document.getElementById("placeDetails");
      const deleteForm = document.getElementById("deleteForm");
      const confirmInput = document.getElementById("confirmInput");
      const deleteBtn = document.getElementById("deleteBtn");
      const statusDiv = document.getElementById("status");

      // Load all places
      loadPlacesBtn.addEventListener("click", async function () {
        await loadPlaces();
      });

      // Search functionality
      searchInput.addEventListener("input", function (e) {
        const query = e.target.value.toLowerCase();
        filterPlaces(query);
      });

      // Confirmation input validation
      confirmInput.addEventListener("input", function (e) {
        const isValid = e.target.value === "DELETE" && selectedPlace;
        deleteBtn.disabled = !isValid;
      });

      async function loadPlaces() {
        loadPlacesBtn.disabled = true;
        loadPlacesBtn.innerHTML =
          '<div class="loading-spinner"></div>Loading places...';

        try {
          const response = await fetch(`${API_BASE}/places`);
          if (!response.ok) {
            throw new Error(
              `Failed to load places: ${response.status} ${response.statusText}`
            );
          }

          const result = await response.json();
          // Handle different possible response structures
          allPlaces = result.data || result.places || result || [];

          displayPlaces(allPlaces);
          placesList.classList.remove("hidden");
          loadPlacesBtn.innerHTML = "ផ្ទុកកន្លែងឡើងវិញ";

          showStatus(`✅ Loaded ${allPlaces.length} places`, "success");
        } catch (error) {
          console.error("Error loading places:", error);
          showStatus(`❌ Error loading places: ${error.message}`, "error");
        } finally {
          loadPlacesBtn.disabled = false;
        }
      }

      function displayPlaces(places) {
        placesList.innerHTML = "";

        if (places.length === 0) {
          placesList.innerHTML =
            '<p class="text-gray-500 text-center py-4">No places found</p>';
          return;
        }

        places.forEach((place) => {
          const placeElement = document.createElement("div");
          placeElement.className =
            "place-item p-4 border-2 border-gray-200 rounded-xl cursor-pointer";
          placeElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800">${
                  place.name || "Unnamed Place"
                }</h3>
                <p class="text-sm text-gray-600 mt-1">${(
                  place.description || ""
                ).substring(0, 100)}${
            (place.description || "").length > 100 ? "..." : ""
          }</p>
                <div class="flex items-center space-x-4 mt-2">
                  <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">${
                    place.categoryName || "No Category"
                  }</span>
                  <span class="text-xs text-gray-500">ID: ${
                    place.id || "N/A"
                  }</span>
                </div>
              </div>
              <div class="text-right">
                <span class="text-sm text-gray-500">$${
                  place.entryFee || 0
                }</span>
              </div>
            </div>
          `;

          placeElement.addEventListener("click", () =>
            selectPlace(place, placeElement)
          );
          placesList.appendChild(placeElement);
        });
      }

      function selectPlace(place, element) {
        // Remove previous selection
        document.querySelectorAll(".place-item").forEach((item) => {
          item.classList.remove("selected");
        });

        // Select new place
        element.classList.add("selected");
        selectedPlace = place;

        // Update form
        document.getElementById("placeId").value = place.id || "";

        // Show place details
        placeDetails.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <strong>Name:</strong> ${place.name || "N/A"}
            </div>
            <div>
              <strong>Category:</strong> ${place.categoryName || "N/A"}
            </div>
            <div>
              <strong>Entry Fee:</strong> $${place.entryFee || 0}
            </div>
            <div>
              <strong>Location:</strong> ${place.location || "N/A"}
            </div>
            <div class="md:col-span-2">
              <strong>Description:</strong> ${place.description || "N/A"}
            </div>
            <div>
              <strong>Open Hours:</strong> ${place.openHours || "N/A"}
            </div>
            <div>
              <strong>Images:</strong> ${
                (place.imageUrls && place.imageUrls.length) || 0
              } image(s)
            </div>
          </div>
        `;

        selectedPlaceInfo.classList.remove("hidden");

        // Reset confirmation
        confirmInput.value = "";
        deleteBtn.disabled = true;

        showStatus(`Selected: ${place.name}`, "info");
      }

      function filterPlaces(query) {
        if (!query) {
          displayPlaces(allPlaces);
          return;
        }

        const filtered = allPlaces.filter(
          (place) =>
            (place.name || "").toLowerCase().includes(query) ||
            (place.description || "").toLowerCase().includes(query) ||
            (place.categoryName || "").toLowerCase().includes(query)
        );

        displayPlaces(filtered);
      }

      // Delete form submission
      deleteForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!selectedPlace || confirmInput.value !== "DELETE") {
          showStatus("❌ Please select a place and confirm deletion", "error");
          return;
        }

        deleteBtn.disabled = true;
        showStatus(
          '<div class="loading-spinner"></div>Deleting place...',
          "loading"
        );

        try {
          const placeUuid = selectedPlace.uuid;

          const response = await fetch(
            `https://tos-der.sokpheng.com/api/v1/places/${placeUuid}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          console.log("Delete response status:", response.status);
          console.log("Delete response headers:", [
            ...response.headers.entries(),
          ]);

          if (!response.ok) {
            let errorMessage = `Delete failed: ${response.status} ${response.statusText}`;

            try {
              const errorData = await response.json();
              console.log("Error response:", errorData);

              // Handle common error scenarios
              if (response.status === 500) {
                if (
                  errorData.message &&
                  errorData.message.includes("constraint")
                ) {
                  errorMessage =
                    "Cannot delete: This place might be referenced by other records (bookings, reviews, etc.). Please check dependencies first.";
                } else if (errorData.message) {
                  errorMessage = `Server error: ${errorData.message}`;
                } else {
                  errorMessage =
                    "Server error occurred. The place might have related data that prevents deletion.";
                }
              } else if (response.status === 404) {
                errorMessage =
                  "Place not found. It might have already been deleted.";
              } else if (response.status === 403) {
                errorMessage =
                  "Access denied. You don't have permission to delete this place.";
              } else if (errorData.message) {
                errorMessage = errorData.message;
              }
            } catch (jsonError) {
              // If error response is not JSON, use text
              try {
                const errorText = await response.text();
                if (errorText) {
                  errorMessage += ` - ${errorText}`;
                }
              } catch (textError) {
                console.error("Could not parse error response", textError);
              }
            }

            throw new Error(errorMessage);
          }

          // Check if response has content
          let result = null;
          try {
            const responseText = await response.text();
            if (responseText) {
              result = JSON.parse(responseText);
            }
          } catch (e) {
            // Response might be empty, which is fine for DELETE
          }

          showStatus(
            `✅ Place "${selectedPlace.name}" deleted successfully!`,
            "success"
          );

          // Reset form
          deleteForm.reset();
          selectedPlace = null;
          selectedPlaceInfo.classList.add("hidden");

          // Reload places
          await loadPlaces();
        } catch (error) {
          console.error("Delete error:", error);
          showStatus(`❌ ${error.message}`, "error");
        } finally {
          deleteBtn.disabled = false;
        }
      });

      function showStatus(message, type) {
        statusDiv.innerHTML = message;
        statusDiv.className = `mt-5 p-4 rounded-lg`;

        switch (type) {
          case "success":
            statusDiv.classList.add(
              "bg-green-100",
              "text-green-800",
              "border",
              "border-green-300"
            );
            break;
          case "error":
            statusDiv.classList.add(
              "bg-red-100",
              "text-red-800",
              "border",
              "border-red-300"
            );
            break;
          case "loading":
            statusDiv.classList.add(
              "bg-blue-100",
              "text-blue-800",
              "border",
              "border-blue-300"
            );
            break;
          case "info":
            statusDiv.classList.add(
              "bg-gray-100",
              "text-gray-800",
              "border",
              "border-gray-300"
            );
            break;
        }

        statusDiv.style.display = "block";

        // Auto-hide success messages after 5 seconds
        if (type === "success") {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 5000);
        }
      }

      // Auto-load places on page load
      window.addEventListener("load", function () {
        loadPlaces();
      });
    </script>

    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script src="../js/script.js"></script>
    <script src="../js/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  </body>
</html>
